events {
    worker_connections 1024;
}

http {
    # JSON log format with WMS parameter extraction
    log_format wms_json escape=json '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"wms_service":"$arg_SERVICE",'
        '"wms_request":"$arg_REQUEST",'
        '"wms_version":"$arg_VERSION",'
        '"wms_layers":"$arg_LAYERS",'
        '"wms_styles":"$arg_STYLES",'
        '"wms_crs":"$arg_CRS",'
        '"wms_srs":"$arg_SRS",'
        '"wms_bbox":"$arg_BBOX",'
        '"wms_width":"$arg_WIDTH",'
        '"wms_height":"$arg_HEIGHT",'
        '"wms_format":"$arg_FORMAT",'
        '"wms_time":"$arg_TIME",'
        '"wms_map":"$arg_MAP"'
    '}';

    upstream mapserver {
        server mapserver:80;
    }

    upstream mapcache {
        server mapcache:80;
    }

    server {
        listen 80;
        server_name localhost;

        # Use JSON logging for access logs
        access_log /var/log/nginx/access.log wms_json;
        error_log /var/log/nginx/error.log;

        # MapServer endpoint
        location /cgi-bin/mapserv {
            proxy_pass http://mapserver/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Add timing header
            add_header X-Request-Time $request_time;
        }

        # MapCache tile endpoint
        location /mapcache/ {
            proxy_pass http://mapcache/mapcache/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Serve viewer.html
        location = / {
            root /usr/share/nginx/html;
            try_files /viewer.html =404;
        }

        location = /viewer.html {
            root /usr/share/nginx/html;
        }

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Nginx status for Prometheus scraping
        location /nginx_status {
            stub_status on;
            allow all;
        }
    }
}
